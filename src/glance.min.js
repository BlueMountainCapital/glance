var glance={version:"0.2-beta3",branch:"graphs"};
(function(){function e(){var a=(window.location.search||"").match(/path=(.+)/),d="";a&&(d=a[1]);return d}glance.displayError=function(a){var d=$("#alert"),b=d[0];d.css("display","");b.innerHTML=b.innerHTML+a+"<br/>"};glance.handler=function(a){return{type:a}};glance.handlers={all:[],add:function(a){if("all"===a.type||"add"===a.type)throw"Cannot add a handler whose type is all or add";this.all.push(a);this[a.type]=a}};glance.page=function(a,d,b){var c=e(),f=new glance.tab;c===a?function(){function c(){var d=
{};glance.data.getAllMetrics(a).forEach(function(d){return function(a){d[a.type]=(d[a.type]||[]).concat(a)}}(d));glance.handlers.all.forEach(function(a){f.getMetrics(a,function(c){void 0!==d[a.type]&&d[a.type].forEach(function(a){c.push(a)});0<c.length&&$("#welcome-alert").css("display","none");d3.select("#data").selectAll(".horizon."+a.type).data(c).call(glance.graphs.horizon(a))})})}document.title="glance | "+d;$(function(){var f=b?'<i class="icon-'+b+'"></i>':d,g=$("#navigation"),l=null,k=$("#search"),
m=$("#search-form");$("#navigation-pills").append('<li class="active"><a href="'+window.location.origin+window.location.pathname+"?path="+a+'">'+f+"</a></li>");c();l=setInterval(function(){clearInterval(l);g.mouseout()},1500);g.mouseover(function(){clearInterval(l);d3.select("#navigation").transition().style("height","30px");d3.select("#navigation-buttons").transition().style("top","20px");d3.select("#navigation-line").transition().style("color","#ffffff")});g.mouseout(function(){d3.select("#navigation").transition().style("height",
"5px");d3.select("#navigation-buttons").transition().style("top","-35px");d3.select("#navigation-line").transition().style("color","#000")});k.keyup(function(){var a=k.val();d3.select("#data").selectAll(".horizon").style("display","").filter(function(d){return!d.matches(a)}).style("display","none")});k.typeahead({source:function(a,d){var c=[];glance.handlers.all.forEach(function(b){b.search(a,function(a){a.forEach(function(a){c.push(a.name)});d(c)})})}});m.submit(function(a){a.preventDefault();var d=
k.val(),b=e();glance.handlers.all.forEach(function(a){a.search(d,function(a){a.forEach(function(a){a.isLeaf&&glance.data.insertMetric(b,a)});c()})})});glance.graphs.axis()})}():$(function(){var c=b?'<i class="icon-'+b+'"></i>':d;$("#navigation-pills").append('<li><a href="'+window.location.origin+window.location.pathname+"?path="+a+'">'+c+"</a></li>")});return f};glance.defaultMetric=function(a){var d=e();$(function(){$("#add-metric").submit(function(b){b.preventDefault();b=glance.handlers[a.type];
var c=glance.metric.prototype.identifier(a.identifier());glance.data.insertMetric(d,c);d3.select("#data").selectAll(".horizon").data([c]).call(glance.graphs.horizon(b));$("#welcome-alert").css("display","none")});$("#add-metric").css("display","")});return this}})();(function(){function e(a){return JSON.parse(localStorage.getItem("metrics-"+a))||[]}function a(a,b){return localStorage.setItem("metrics-"+a,JSON.stringify(b))}glance.data={getAllMetrics:function(a){var b=e(a).map(glance.metric.prototype.identifier);b.forEach(function(c){c.remove=function(){glance.data.removeMetric(a,c)}});return b},insertMetric:function(d,b){a(d,e(d).concat(b.identifier()))},resetPath:function(d){a(d,[])},removeMetric:function(d,b){var c=b.identifier();a(d,e(d).filter(function(a){return a!==
c}))}}})();(function(){glance.graphite=function(e){var a=glance.handler("graphite");a.createMetric=function(d,b){var c=new glance.metric(d,a.type);c.path=d;c.isLeaf=b;c.getPath=function(){var a=d;this.asPercentage&&(a="asPercent("+a+","+this.asPercentage+")");this.keepLastValue&&(a="keepLastValue("+a+")");return a};c.calculate=function(a,d,b,g){a=e+"/render?format=json&target="+encodeURIComponent(this.getPath(b))+"&from="+Math.floor(a/1E3)+"&until="+Math.floor(d/1E3);var l=d3.json(a,function(a){c.cancel=null;
if(!a)return g(Error("unable to load data"));g(null,a[0].datapoints.map(function(a){return[a[1],a[0]]}))});c.cancel=function(){l.abort()}};return c};a.search=function(d,b){d3.json(e+"/metrics/find?format=completer&query="+d,function(d){var f=[];d.metrics.forEach(function(d){f.push(a.createMetric(d.path,"1"===d.is_leaf))});b(f)})};a.alias=function(d){var b=a.createMetric;a.createMetric=function(){var c=b.apply(a,arguments);c.alias=d(c.name);c.matches=function(a){return 0<=this.alias.indexOf(a)||0<=
this.name.indexOf(a)};return c};return a};a.startSearches=function(d){var b=a.search,c=a.createMetric;a.search=function(a,c){b(d+a,function(a){a.forEach(function(a){a.name=a.path.substr(d.length)});c(a)})};a.createMetric=function(a,b){0!==a.indexOf(d)&&(a=d+a);return c(a,b)};return this};a.baseStep=function(d){var b=a.createMetric;a.createMetric=function(){var c=b.apply(a,arguments),e=c.getPath;c.getPath=function(a){var b=e.call(c,a);return d===a?b:"summarize("+b+",'"+(!(a%36E5)?a/36E5+"hour":!(a%
6E4)?a/6E4+"min":a/1E3+"sec")+"')"};return c};return a};glance.handlers.add(a);return a}})();(function(){function e(){}var a=e.prototype;a.horizon=function(a){return function(b){var c=b.enter().append("div",".bottom").attr("class","horizon "+a.type).style("height","20px").style("width","1280px"),e=d3.horizon().width(1280).height(20).bands(5).mode("offset");c.append("div").attr("class","label label-info title");c.append("div").attr("class","label label-info value");c.append("svg").attr("class","svg-data").attr("width","1280px").attr("height","20px");c.each(function(a){if(a.remove)c.append("div").attr("class",
"label label-important remove").style("right","0px").style("display","none").append("a").append("i").attr("class","icon-trash").on("click",function(){a.remove();c.remove()})});b.each(function(a){var d=d3.select(this),b=Date.now()-1E4,c=new Date(b-128E5),k=new Date(b),m=d3.format(a.format()),n=null,p=function(){a.calculate(c,k,1E4,function(b,c){if(b)glance.displayError(b);else{a.values=c;var g=c[c.length-1];d.select(".value").text(m(g[1]));d.select(".svg-data").data([c]).call(e)}})},q=setInterval(function(){b=
Date.now()-1E4;c=new Date(b-128E5);k=new Date(b);p()},1E4);d.select(".title").text(a.alias||a.name);d.on("mousemove",function(a,b){var c=d[0][0],e=d3.mouse(c),f=c.clientWidth-e[0];d3.select("#data").selectAll(".horizon").selectAll(".value").style("right",f+"px").text(function(a){if(a.values)return m(a.values[a.values.length-f][1])})}).on("mouseout",function(a,b){d3.select("#data").selectAll(".horizon").selectAll(".value").style("right",null);d.select(".remove").style("display","none")}).on("mouseover",
function(a,b){d.select(".remove").style("display","")});n&&n();a.calculate&&(n=function(){clearInterval(q);a.cancel()},p())});b.exit().each(function(a){a.cancel()}).remove()}};a.axis=function(){};glance.graphs=new e})();(function(){function e(a,b){this.name=a;this.type=b}var a=e.prototype;a.matches=function(a){return 0<=this.name.indexOf(a)};a.isLeaf=!1;a.identifier=function(a){return"string"===typeof a?(a=a.split(";"),glance.handlers[a[0]].createMetric(a[1])):this.type+";"+this.name};a.format=function(){return",.2f"};glance.metric=e})();(function(){glance.persistence=function(e){$("#share").css("display","");$("#share").click(function(a){a.preventDefault()})}})();(function(){function e(){}var a=e.prototype;a.getMetrics=function(a,b){this.retrieveMetrics(a,b,[])};a.retrieveMetrics=function(a,b){b([])};a.metrics=function(a){var b=this.retrieveMetrics;this.retrieveMetrics=function(c,e,h){a(c,function(a){a.forEach(function(a){a.isLeaf&&h.push(a)});e(h)});b(c,e,h)};return this};a.search=function(a){this.metrics(function(b,c){b.search(a,c)});return this};a.call=function(a){var b=this.retrieveMetrics;this.retrieveMetrics=function(c,e,h){b(c,function(b){b.forEach(a);
e(b)},h)};return this};a.sort=function(a){var b=this.retrieveMetrics;this.retrieveMetrics=function(c,e,h){b(c,function(b){b.sort(a||c.comparer);e(b)},h)};return this};a.asPercent=function(a){this.call(function(b){b.asPercentage=a});return this};a.keepLast=function(){this.call(function(a){a.keepLastValue=!0});return this};glance.tab=e})();
