var glance={version:"0.2-beta3",branch:"demo"};
(function(){function e(){var c=(window.location.search||"").match(/path=(.+)/),b="";c&&(b=c[1]);return b}function d(c){this.type=c}glance.displayError=function(c){var b=$("#alert"),a=b[0];b.css("display","");a.innerHTML=a.innerHTML+c+"<br/>"};glance.handler=function(c){return new d(c)};var a=d.prototype;a.alias=function(c){var b=this,a=b.createMetric;b.createMetric=function(){var f=a.apply(b,arguments);f.alias=c(f.name);f.matches=function(c){return 0<=this.alias.indexOf(c)||0<=this.name.indexOf(c)};
return f};return b};a.startSearches=function(c){var b=this.search,a=this.createMetric;this.search=function(a,d){b(c+a,function(a){a.forEach(function(a){a.name=a.path.substr(c.length)});d(a)})};this.createMetric=function(b,d){0!==b.indexOf(c)&&(b=c+b);return a(b,d)};return this};glance.handlers={all:[],add:function(a){if("all"===a.type||"add"===a.type)throw"Cannot add a handler whose type is all or add";this.all.push(a);this[a.type]=a}};glance.page=function(a,b,d){var f=e(),p=new glance.tab;f===a?
function(){function f(){var b={};glance.data.getAllMetrics(a).forEach(function(a){return function(b){a[b.type]=(a[b.type]||[]).concat(b)}}(b));glance.handlers.all.forEach(function(a){p.getMetrics(a,function(c){void 0!==b[a.type]&&b[a.type].forEach(function(a){c.push(a)});0<c.length&&$("#welcome-alert").css("display","none");d3.select("#data").selectAll(".horizon."+a.type).data(c).call(glance.graphs.horizon(a))})})}document.title="glance | "+b;$(function(){var p=d?'<i class="icon-'+d+'"></i>':b,m=
$("#navigation"),l=null,g=$("#search"),n=$("#search-form");$("#navigation-pills").append('<li class="active"><a href="'+window.location.origin+window.location.pathname+"?path="+a+'">'+p+"</a></li>");f();l=setInterval(function(){clearInterval(l);m.mouseout()},1500);m.mouseover(function(){clearInterval(l);d3.select("#navigation").transition().style("height","30px");d3.select("#navigation-buttons").transition().style("top","20px");d3.select("#navigation-line").transition().style("color","#ffffff")});
m.mouseout(function(){d3.select("#navigation").transition().style("height","5px");d3.select("#navigation-buttons").transition().style("top","-35px");d3.select("#navigation-line").transition().style("color","#000")});g.keyup(function(){var a=g.val();d3.select("#data").selectAll(".horizon").style("display","").filter(function(b){return!b.matches(a)}).style("display","none")});g.typeahead({source:function(a,b){var c=[];glance.handlers.all.forEach(function(d){d.search(a,function(a){a.forEach(function(a){c.push(a.name)});
b(c)})})}});n.submit(function(a){a.preventDefault();var b=g.val(),c=e();glance.handlers.all.forEach(function(a){a.search(b,function(a){a.forEach(function(a){a.isLeaf&&glance.data.insertMetric(c,a)});f()})})});glance.graphs.axis()})}():$(function(){var f=d?'<i class="icon-'+d+'"></i>':b;$("#navigation-pills").append('<li><a href="'+window.location.origin+window.location.pathname+"?path="+a+'">'+f+"</a></li>")});return p};glance.defaultMetric=function(a){var b=e();$(function(){$("#add-metric").submit(function(d){d.preventDefault();
d=glance.handlers[a.type];var f=glance.metric.prototype.identifier(a.identifier());glance.data.insertMetric(b,f);d3.select("#data").selectAll(".horizon").data([f]).call(glance.graphs.horizon(d));$("#welcome-alert").css("display","none")});$("#add-metric").css("display","")});return this}})();(function(){function e(a){return JSON.parse(localStorage.getItem("metrics-"+a))||[]}function d(a,c){return localStorage.setItem("metrics-"+a,JSON.stringify(c))}glance.data={getAllMetrics:function(a){var c=e(a).map(glance.metric.prototype.identifier);c.forEach(function(b){b.remove=function(){glance.data.removeMetric(a,b)}});return c},insertMetric:function(a,c){d(a,e(a).concat(c.identifier()))},resetPath:function(a){d(a,[])},removeMetric:function(a,c){var b=c.identifier();d(a,e(a).filter(function(a){return a!==
b}))}}})();(function(){glance.demo=function(e){var d=glance.handler("demo");d.createMetric=function(a,c,b){var k=new glance.metric(a,d.type);k.path=a;k.isLeaf=c;k.getPath=function(){return a};k.cancel=function(){};k.calculate=function(a,c,d,k){var e=(b||[0,1]).sort();a=a.valueOf();for(var l=e[1]-e[0],g=Math.random()*l+e[0],l=l/10,n=[[a,g]];a<c.valueOf();)a+=d,g=Math.min(Math.max(g+Math.random()*l*(0.5<Math.random()?1:-1),e[0]),e[1]),n.push([a,g]);k(null,n)};return k};d.search=function(a,c){c(e.filter(function(b){return b.matches(a)}).map(function(a){var c=
d.createMetric(a.path,!0,a.limits);c.name=a.alias||a.name||a.path;return c}))};glance.handlers.add(d);return d}})();(function(){glance.graphite=function(e){var d=glance.handler("graphite");d.createMetric=function(a,c){var b=new glance.metric(a,d.type);b.path=a;b.isLeaf=c;b.getPath=function(){var b=a;this.asPercentage&&(b="asPercent("+b+","+this.asPercentage+")");this.keepLastValue&&(b="keepLastValue("+b+")");return b};b.calculate=function(a,c,d,q){a=e+"/render?format=json&target="+encodeURIComponent(this.getPath(d))+"&from="+Math.floor(a/1E3)+"&until="+Math.floor(c/1E3);var r=d3.json(a,function(a){b.cancel=null;
if(!a)return q(Error("unable to load data"));q(null,a[0].datapoints.map(function(a){return[a[1],a[0]]}))});b.cancel=function(){r.abort()}};return b};d.search=function(a,c){d3.json(e+"/metrics/find?format=completer&query="+a,function(a){var k=[];a.metrics.forEach(function(a){k.push(d.createMetric(a.path,"1"===a.is_leaf))});c(k)})};d.alias=function(a){var c=d.createMetric;d.createMetric=function(){var b=c.apply(d,arguments);b.alias=a(b.name);b.matches=function(a){return 0<=this.alias.indexOf(a)||0<=
this.name.indexOf(a)};return b};return d};d.startSearches=function(a){var c=d.search,b=d.createMetric;d.search=function(b,d){c(a+b,function(b){b.forEach(function(b){b.name=b.path.substr(a.length)});d(b)})};d.createMetric=function(c,d){0!==c.indexOf(a)&&(c=a+c);return b(c,d)};return this};d.baseStep=function(a){var c=d.createMetric;d.createMetric=function(){var b=c.apply(d,arguments),e=b.getPath;b.getPath=function(c){var d=e.call(b,c);return a===c?d:"summarize("+d+",'"+(!(c%36E5)?c/36E5+"hour":!(c%
6E4)?c/6E4+"min":c/1E3+"sec")+"')"};return b};return d};glance.handlers.add(d);return d}})();(function(){function e(){}var d=e.prototype;d.horizon=function(a){return function(c){var b=c.enter().append("div",".bottom").attr("class","horizon "+a.type).style("height","20px").style("width","1280px"),d=d3.horizon().width(1280).height(20).bands(5).mode("offset");b.append("div").attr("class","label label-info title");b.append("div").attr("class","label label-info value");b.append("svg").attr("class","svg-data").attr("width","1280px").attr("height","20px");b.each(function(a){if(a.remove)b.append("div").attr("class",
"label label-important remove").style("right","0px").style("display","none").append("a").append("i").attr("class","icon-trash").on("click",function(){a.remove();b.remove()})});c.each(function(a){var b=d3.select(this),c=Date.now()-1E4,e=new Date(c-128E5),m=new Date(c),l=d3.format(a.format()),g=null,n=function(){a.calculate(e,m,1E4,function(c,e){var g=[],h=null,h=0;if(c)glance.displayError(c);else{if(1280>e.length){for(h=0;h<1280-e.length;h+=1)g[h]=a.values[h+e.length];for(h=0;h<e.length;h+=1)g[h+(1280-
e.length)]=e[h];e=g}a.values=e;h=e[e.length-1];b.select(".value").text(l(h[1]));b.select(".svg-data").data([e]).call(d)}})},s=setInterval(function(){c=Date.now()-1E4;e=m;m=new Date(c);n()},1E4);b.select(".title").text(a.alias||a.name);b.on("mousemove",function(a,c){var d=b[0][0],e=d3.mouse(d),f=d.clientWidth-e[0];d3.select("#data").selectAll(".horizon").selectAll(".value").style("right",f+"px").text(function(a){if(a.values)return l(a.values[a.values.length-f][1])})}).on("mouseout",function(a,c){d3.select("#data").selectAll(".horizon").selectAll(".value").style("right",
null);b.select(".remove").style("display","none")}).on("mouseover",function(a,c){b.select(".remove").style("display","")});g&&g();a.calculate&&(g=function(){clearInterval(s);a.cancel()},n())});c.exit().each(function(a){a.cancel()}).remove()}};d.axis=function(){};glance.graphs=new e})();(function(){function e(a,c){this.name=a;this.type=c}var d=e.prototype;d.matches=function(a){return 0<=this.name.indexOf(a)};d.isLeaf=!1;d.identifier=function(a){return"string"===typeof a?(a=a.split(";"),glance.handlers[a[0]].createMetric(a[1])):this.type+";"+this.name};d.format=function(){return",.2f"};glance.metric=e})();(function(){glance.persistence=function(e){$("#share").css("display","");$("#share").click(function(d){d.preventDefault()})}})();(function(){function e(){}var d=e.prototype;d.getMetrics=function(a,c){this.retrieveMetrics(a,c,[])};d.retrieveMetrics=function(a,c){c([])};d.metrics=function(a){var c=this.retrieveMetrics;this.retrieveMetrics=function(b,d,e){c(b,d,e);a(b,function(a){a.forEach(function(a){a.isLeaf&&e.push(a)});d(e)})};return this};d.search=function(a){this.metrics(function(c,b){c.search(a,b)});return this};d.call=function(a){var c=this.retrieveMetrics;this.retrieveMetrics=function(b,d,e){c(b,function(b){b.forEach(a);
d(b)},e)};return this};d.sort=function(a){var c=this.retrieveMetrics;this.retrieveMetrics=function(b,d,e){c(b,function(c){c.sort(a||b.comparer);d(c)},e)};return this};d.asPercent=function(a){this.call(function(c){c.asPercentage=a});return this};d.keepLast=function(){this.call(function(a){a.keepLastValue=!0});return this};glance.tab=e})();
