var glance={version:"0.2-beta2",branch:"graphs"};
(function(){function e(){var b=(window.location.search||"").match(/path=(.+)/),a="";b&&(a=b[1]);return a}glance.displayError=function(b){var a=$("#alert"),d=a[0];a.css("display","");d.innerHTML=d.innerHTML+b+"<br/>"};glance.handler=function(b){return{type:b}};glance.handlers={all:[],add:function(b){if("all"===b.type||"add"===b.type)throw"Cannot add a handler whose type is all or add";this.all.push(b);this[b.type]=b}};glance.page=function(b,a,d){var c=e(),f=new glance.tab;if(c===b){var g=function(){var a=
{};glance.data.getAllMetrics(b).forEach(function(a){return function(b){a[b.type]=(a[b.type]||[]).concat(b)}}(a));glance.handlers.all.forEach(function(b){f.getMetrics(b,function(d){void 0!==a[b.type]&&a[b.type].forEach(function(a){d.push(a)});0<d.length&&$("#welcome-alert").css("display","none");d3.select("#data").selectAll(".horizon."+b.type).data(d).call(glance.graphs.horizon(b))})})};document.title="glance | "+a;$(function(){var f=d?'<i class="icon-'+d+'"></i>':a,c=$("#navigation"),h=null,j=$("#search"),
k=$("#search-form");$("#navigation-pills").append('<li class="active"><a href="'+window.location.origin+window.location.pathname+"?path="+b+'">'+f+"</a></li>");g();h=setInterval(function(){clearInterval(h);c.mouseout()},1500);c.mouseover(function(){clearInterval(h);d3.select("#navigation").transition().style("height","30px");d3.select("#navigation-buttons").transition().style("top","20px");d3.select("#navigation-line").transition().style("color","#ffffff")});c.mouseout(function(){d3.select("#navigation").transition().style("height",
"5px");d3.select("#navigation-buttons").transition().style("top","-35px");d3.select("#navigation-line").transition().style("color","#000")});j.keyup(function(){var a=j.val();d3.select("#data").selectAll(".horizon").style("display","").filter(function(b){return!b.matches(a)}).style("display","none")});j.typeahead({source:function(a,b){var d=[];glance.handlers.all.forEach(function(f){f.search(a,function(a){a.forEach(function(a){d.push(a.name)});b(d)})})}});k.submit(function(a){a.preventDefault();var b=
j.val(),d=e();glance.handlers.all.forEach(function(a){a.search(b,function(a){a.forEach(function(a){a.isLeaf&&glance.data.insertMetric(d,a)});g()})})});glance.graphs.axis()})}else $(function(){var f=d?'<i class="icon-'+d+'"></i>':a;$("#navigation-pills").append('<li><a href="'+window.location.origin+window.location.pathname+"?path="+b+'">'+f+"</a></li>")});return f};glance.defaultMetric=function(b){var a=this.handlers,d=e(),c=b.type;$(function(){$("#add-metric").submit(function(f){f.preventDefault();
glance.data.insertMetric(d,b);f=a.filter(function(a){return c===a.type});1<f.length?glance.displayError("Multiple matching handlers for type "+c):0===f.length?glance.displayError("No matching handlers for type "+c):f[0].data([b]);$("#welcome-alert").css("display","none")});$("#add-metric").css("display","")});return this}})();(function(){function e(a){return JSON.parse(localStorage.getItem("metrics-"+a))||[]}function b(a,b){return localStorage.setItem("metrics-"+a,JSON.stringify(b))}glance.data={getAllMetrics:function(a){a=e(a).map(glance.metric.prototype.identifier);a.forEach(function(a){a.remove=function(){glance.data.removeMetric(a)}});return a},insertMetric:function(a,d){b(a,e(a).concat(d.identifier()))},resetPath:function(a){b(a,[])},removeMetric:function(a,d){var c=d.identifier();b(a,e(a).filter(function(a){return a!==
c}))}}})();(function(){glance.graphite=function(e){var b=glance.handler("graphite");b.createMetric=function(a,d){var c=new glance.metric(a,b.type);c.path=a;c.isLeaf=d;c.getPath=function(){var b=a;this.asPercentage&&(b="asPercent("+b+","+this.asPercentage+")");this.keepLastValue&&(b="keepLastValue("+b+")");return b};c.calculate=function(a,b,d,c){a=e+"/render?format=json&target="+encodeURIComponent(this.getPath())+"&from="+Math.floor(a/1E3)+"&until="+Math.floor(b/1E3);this.cancellation=d3.json(a,function(a){if(!a)return c(Error("unable to load data"));
c(null,a[0].datapoints.map(function(a){return[a[1],a[0]]}))})};c.cancel=function(){this.cancellation.abort()};return c};b.search=function(a,d){d3.json(e+"/metrics/find?format=completer&query="+a,function(a){var f=[];a.metrics.forEach(function(a){f.push(b.createMetric(a.path,"1"===a.is_leaf))});d(f)})};b.alias=function(a){var d=b.createMetric;b.createMetric=function(){var c=d.apply(b,arguments);c.alias=a(c.name);c.matches=function(a){return 0<=this.alias.indexOf(a)||0<=this.name.indexOf(a)};return c};
return b};b.startSearches=function(a){var d=b.search,c=b.createMetric;b.search=function(b,c){d(a+b,function(b){b.forEach(function(b){b.name=b.path.substr(a.length)});c(b)})};b.createMetric=function(b,d){0!==b.indexOf(a)&&(b=a+b);return c(b,d)};return this};glance.handlers.add(b);return b}})();(function(){function e(){}var b=e.prototype;b.horizon=function(a){return function(b){var c=b.enter().append("div",".bottom").attr("class","horizon "+a.type).style("height","20px").style("width","1280px"),f=d3.horizon().width(1280).height(20).bands(5).mode("offset");c.append("div").attr("class","label label-info title");c.append("div").attr("class","label label-info value");c.append("svg").attr("class","svg-data").attr("width","1280px").attr("height","20px");b.each(function(a){var b=d3.select(this),
d=Date.now()-1E4,c=new Date(d-128E5),d=new Date(d),e=d3.format(a.format());b.select(".title").text(a.alias||a.name);b.on("mousemove",function(a,d){var c=b[0][0],f=d3.mouse(c),c=c.clientWidth-f[0];d3.select("#data").selectAll(".horizon").selectAll(".value").style("right",c+"px").text(function(a){return e(a.values[d])})}).on("mouseout",function(){d3.select("#data").selectAll(".horizon").selectAll(".value").style("right",null)});a.calculate(c,d,1E4,function(d,c){if(d)glance.displayError(d);else{a.values=
c;var h=c[c.length-1];b.select(".value").text(e(h[1]));b.select(".svg-data").data([c]).call(f)}})});b.exit().each(function(a){a.cancel()}).remove()}};b.axis=function(){};glance.graphs=new e})();(function(){function e(a,b){this.name=a;this.type=b}var b=e.prototype;b.matches=function(a){return 0<=this.name.indexOf(a)};b.isLeaf=!1;b.remove=function(){};b.cancel=function(){};b.calculate=function(){};b.identifier=function(a){return"string"===typeof a?(a=a.split(";"),glance.handlers[a[0]].createMetric(a[1])):this.type+";"+this.name};b.format=function(){return",.2f"};glance.metric=e})();(function(){glance.persistence=function(){$("#share").css("display","");$("#share").click(function(e){e.preventDefault()})}})();(function(){function e(){}var b=e.prototype;b.getMetrics=function(a,b){this.retrieveMetrics(a,b,[])};b.retrieveMetrics=function(a,b){b([])};b.metrics=function(a){var b=this.retrieveMetrics;this.retrieveMetrics=function(c,f,e){a(c,function(a){a.forEach(function(a){a.isLeaf&&e.push(a)});f(e)});b(c,f,e)};return this};b.search=function(a){this.metrics(function(b,c){b.search(a,c)});return this};b.call=function(a){var b=this.retrieveMetrics;this.retrieveMetrics=function(c,e,g){b(c,function(b){b.forEach(a);
e(b)},g)};return this};b.sort=function(a){var b=this.retrieveMetrics;this.retrieveMetrics=function(c,e,g){b(c,function(b){b.sort(a||c.comparer);e(b)},g)};return this};b.asPercent=function(a){this.call(function(b){b.asPercentage=a});return this};b.keepLast=function(){this.call(function(a){a.keepLastValue=!0});return this};glance.tab=e})();
